<div class="container">
    <div class="box">
        <nav class="navbar navbar-light bg-danger">
        <%= link_to '#', class:"text-white navbar-brand" do %>
            <%= image_tag ('https://bit.ly/2Dx67Wk'), size: '30x30', class:"d-inline-block align-top", alt:"" %>
            The Game!
        <% end %>
        </nav>
        <h1>Hangman Game - Rails! </h1>
        <h3>Health: <span id="health">4</span></h3>

        <div id="hearts" style="text-align: right; margin-right: 10px;display: inline-block;float: right;">
            <% 4.times do |i| %>
                <%= image_tag 'https://bit.ly/2BCFoHP', size:"40x40", id:"heart_#{i}" %>
            <% end %>
        </div>

        <% secret_word = @words.word  %>
        <% word = toArray(secret_word)[0] %>
        <p>Secret word: <%= toArray(secret_word)[1] %></p>
        <br><br><br><br><br><br>
        <div style="text-align: center;" id="whiteEspaces">
            <% secret_word.size.times do |i| %>
                <h3 id="wE_<%= i %>">__</h3>
            <% end %>
        </div>
        <br><br><br><br>
        <div id='letters' class="letters">
            <% c = 0%>
            <% word.each do |e| %>

                <%= button_tag(type: 'button', id:c, class:"btn btn-primary shadow", value:e) do %>
                    <%= e %>
                <% end %>
                <% c+=1 %>
                
            <% end %>
        </div>
    </div>
</div>

<script>
    var el = document.getElementById('letters');
    el.addEventListener('click', function(e) {
        const id = e.target.id.toString()
        if (id === 'letters') { return }
        let  word= '<%= word.join('') %>'
        word = word.split("")
        var secret_word = ('<%= secret_word %>')
        var remaining = 4
        function logArrayElements(element, index, array) {
            var getValue = document.getElementById(id).value
            var value = getValue
            var inside = secret_word.includes(value)
            let keyPressed = getValue
            //console.log(inside)
            if (!inside) {
                var element = document.getElementById(id).className = "btn btn-danger";
                var health = document.getElementsByClassName("btn btn-danger").length * (-1) + remaining
                heart = document.getElementById("heart_"+health)
                if (health === 0) {
                    $("#heart_"+health).addClass("disabledbutton")
                } else {
                    $("#heart_"+health).hide()
                }
                document.getElementById('health').innerHTML = health
                if (health == 0) {
                    document.getElementById("health").className = "text-danger"
                    document.getElementById("health").innerHTML = "GAME OVER!"
                    disableDiv()
                    sleep(3000).then(() => {
                        location.reload()
                    })
                }
                return null
            } else {
                document.getElementById(id).className = "btn btn-success";
                setButtonClass(word, keyPressed, "btn btn-success")
                pushLetters(secret_word, keyPressed)
                let corrects = document.getElementsByClassName("btn btn-success").length
                let notWhiteEspaces = document.getElementsByName("not_wE").length
                let allCorrects = corrects === secret_word.length || secret_word.length === notWhiteEspaces
                if (allCorrects ) {
                    document.getElementById("health").className = "text-success"
                    document.getElementById("health").innerHTML = "CONGRATULATIONS!"
                    disableDiv()
                    sleep(3000).then(() => {
                        location.reload()
                    })
                }
            }
        }
        word.forEach(logArrayElements);
    })

    const setButtonClass = (word, keyPressed, classBootstrap) => {
        for (let c = 0; c < word.length; c++) {
            if (word[c] == keyPressed) {
                console.log(c, keyPressed)
                document.getElementById(c).className = classBootstrap;
            }
        }
    }

    const pushLetters = (secret_word, keyPressed) => {
        for (let pos in secret_word) {
            if (secret_word[pos] === keyPressed) {
                document.getElementById(`wE_${pos}`).innerHTML = keyPressed;
                $('#wE_' + pos).attr('name', 'not_wE');
            }
        }
    }

    const disableDiv = _ => {
        $("#letters").addClass("disabledbutton")
    }
    
    const sleep = (milliseconds) => {
        return new Promise(resolve => setTimeout(resolve, milliseconds))
    }
</script>